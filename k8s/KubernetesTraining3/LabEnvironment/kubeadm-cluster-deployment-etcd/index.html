<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-k8s docs-version-current docs-doc-page docs-doc-id-KubernetesTraining3/实验环境部署/kubeadm-cluster-deployment-etcd" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Kubeadm+外部etcd部署集群 | Ryan&#x27;s Wiki</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ryanxin7.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ryanxin7.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ryanxin7.github.io/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-k8s-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-k8s-current"><meta data-rh="true" property="og:title" content="Kubeadm+外部etcd部署集群 | Ryan&#x27;s Wiki"><meta data-rh="true" name="description" content="一、架构图"><meta data-rh="true" property="og:description" content="一、架构图"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ryanxin7.github.io/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd"><link data-rh="true" rel="alternate" href="https://ryanxin7.github.io/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd" hreflang="en"><link data-rh="true" rel="alternate" href="https://ryanxin7.github.io/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UTHK6Z5YDW-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ryan&#39;s Wiki RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ryan&#39;s Wiki Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Ryan&#39;s Wiki" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.d3c714a5.css">
<script src="/assets/js/runtime~main.f6f6a36d.js" defer="defer"></script>
<script src="/assets/js/main.bc8ddf24.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ryan&#x27;s wiki</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/k8s/intro">Kubernetes</a><a class="navbar__item navbar__link" href="/haproxy/haproxy-1">haproxy</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/k8s/category/kubernetes-进阶训练综合实践-2">kubernetes 进阶训练综合实践</a><button aria-label="Collapse sidebar category &#x27;kubernetes 进阶训练综合实践&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/k8s/KubernetesTraining3/intro">Introduction to Kubernetes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/k8s/KubernetesTraining3/实验环境部署/3333">实验环境部署</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/k8s/KubernetesTraining3/实验环境部署/3333">发布集群控制面板</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd">Kubeadm+外部etcd部署集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment">Kubeadm 部署集群</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/k8s/intro">Tutorial Intro</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/k8s/6">【Kubeadm】Ubuntu20.04 部署 kubernetes 1.22.2版本集群</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/k8s/category/kubernetes-进阶训练综合实践-2"><span itemprop="name">kubernetes 进阶训练综合实践</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">实验环境部署</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kubeadm+外部etcd部署集群</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Kubeadm+外部etcd部署集群</h1></header><a name="HQDo8"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一架构图">一、架构图<a class="hash-link" aria-label="Direct link to 一、架构图" title="Direct link to 一、架构图" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#一架构图">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://docusaurus.io/img/docusaurus.png" alt="Docusaurus Logo" class="img_ev3q">
<img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/33538388/1710222413861-72067b8a-cb16-49f2-ad0d-a27c2108339b.png#averageHue=%23dcb14e&amp;clientId=u3e7b0f16-9251-4&amp;from=paste&amp;id=uf741a1e0&amp;originHeight=448&amp;originWidth=1088&amp;originalType=url&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u2406c8e6-038f-4024-b1c8-640a0200596&amp;title=" alt="222" class="img_ev3q"></p>
<a name="rWJIc"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二环境信息">二、环境信息<a class="hash-link" aria-label="Direct link to 二、环境信息" title="Direct link to 二、环境信息" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#二环境信息">​</a></h2>
<table><thead><tr><th>主机名</th><th>系统版本</th><th>内核版本</th><th>K8S版本</th><th>IP地址</th><th>备注</th></tr></thead><tbody><tr><td>etcd01,k8s-master-01</td><td>Ubuntu 20.04.3 LTS</td><td>5.4.0-81-generic</td><td>1.24.12</td><td>192.168.10.96</td><td>etcd节点,master节点</td></tr><tr><td>etcd02,k8s-node-01</td><td>Ubuntu 20.04.3 LTS</td><td>5.4.0-81-generic</td><td>1.24.12</td><td>192.168.10.97</td><td>etcd节点,node节点</td></tr><tr><td>etcd03,k8s-node-02</td><td>Ubuntu 20.04.3 LTS</td><td>5.4.0-81-generic</td><td>1.24.12</td><td>192.168.10.98</td><td>etcd节点,node节点</td></tr></tbody></table>
<a name="bxUbD"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三安装和配置先决条件">三、安装和配置先决条件<a class="hash-link" aria-label="Direct link to 三、安装和配置先决条件" title="Direct link to 三、安装和配置先决条件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#三安装和配置先决条件">​</a></h2>
<a name="S0Dvy"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31主机名设置">3.1、主机名设置<a class="hash-link" aria-label="Direct link to 3.1、主机名设置" title="Direct link to 3.1、主机名设置" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#31主机名设置">​</a></h3>
<p><strong>说明：分别在对应的节点IP上设置主机名。</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname etcd01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname etcd02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname etcd03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname master01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hostnamectl set-hostname node02</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="WclxD"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32配置主机hosts">3.2、配置主机hosts<a class="hash-link" aria-label="Direct link to 3.2、 配置主机hosts" title="Direct link to 3.2、配置主机hosts" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#32配置主机hosts">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.96 etcd01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.97 etcd02</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.98 etcd03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.96 master01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.97 node01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.98 node02</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deb http://security.ubuntu.com/ubuntu/ focal-security main restricted universe multiverse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb-src http://security.ubuntu.com/ubuntu/ focal-security main restricted universe multiverse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 预发布软件源，不建议启用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># # deb-src http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-proposed main restricted universe multiverse</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="LxZO1"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33关闭防火墙">3.3、关闭防火墙<a class="hash-link" aria-label="Direct link to 3.3、关闭防火墙" title="Direct link to 3.3、关闭防火墙" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#33关闭防火墙">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ufw status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ufw disable</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="QAPsu"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34关闭selinux">3.4、关闭selinux<a class="hash-link" aria-label="Direct link to 3.4、关闭selinux" title="Direct link to 3.4、关闭selinux" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#34关闭selinux">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> selinux-utils </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> policycoreutils </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s#SELINUX=permissive#SELINUX=disabled#g&#x27;</span><span class="token plain"> /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sestatus </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELinux status:                 disabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：如果selinux默认关闭则无需修改。</p>
<a name="cFjLO"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="35关闭swap分区">3.5、关闭swap分区<a class="hash-link" aria-label="Direct link to 3.5、关闭swap分区" title="Direct link to 3.5、关闭swap分区" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#35关闭swap分区">​</a></h3>
<p><strong>说明：以下操作无论是master节点和worker节点均需要执行。</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">swapoff </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s/^\/swapfile\(.*\)$/#\/swapfile \1/g&#x27;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="ZMDgu"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="36时间时区同步">3.6、时间时区同步<a class="hash-link" aria-label="Direct link to 3.6、时间时区同步" title="Direct link to 3.6、时间时区同步" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#36时间时区同步">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<p>1、设置时区为Asia/Shanghai，如果已经是则请忽略</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># timedatectl set-timezone Asia/Shanghai</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># timedatectl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Local time: Thu </span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">-03-07 </span><span class="token number" style="color:#36acaa">15</span><span class="token plain">:09:02 CST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Universal time: Thu </span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">-03-07 07:09:02 UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 RTC time: Thu </span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">-03-07 07:09:03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Time zone: Asia/Shanghai </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CST, +0800</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System clock synchronized: </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              NTP service: active</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          RTC </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin class-name">local</span><span class="token plain"> TZ: no</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、使用chrony同步时间</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> chrony </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/chrony/chrony.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp.aliyun.com minpoll </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> maxpoll </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server ntp1.aliyun.com minpoll </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> maxpoll </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> iburst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#pool ntp.ubuntu.com        iburst maxsources 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#pool 0.ubuntu.pool.ntp.org iburst maxsources 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#pool 1.ubuntu.pool.ntp.org iburst maxsources 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#pool 2.ubuntu.pool.ntp.org iburst maxsources 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> chrony</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart chronyd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status chronyd.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>然后就是chrony客户端上的一些常用命令：</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#查看可用的时间同步源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc sources </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#查看时间同步源的状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc sourcestats </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#对客户端系统时间进行强制同步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chronyc </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> makestep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="cZXmQ"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="37修改内核参数">3.7、修改内核参数<a class="hash-link" aria-label="Direct link to 3.7、修改内核参数" title="Direct link to 3.7、修改内核参数" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#37修改内核参数">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<p>说明：有一些ipv4的流量不能走iptables链，因为linux内核的一个过滤器，每个流量都会经过他，然后再匹配是否可进入当前应用进程去处理，所以会导致流量丢失。配置k8s.conf文件,如下所示：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/k8s.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置所需的sysctl参数，参数在重新启动后保持不变</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/k8s.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 应用sysctl参数而不重新启动</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--system</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="XuQx8"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="38启用ipvs模式">3.8、启用IPVS模式<a class="hash-link" aria-label="Direct link to 3.8、启用IPVS模式" title="Direct link to 3.8、启用IPVS模式" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#38启用ipvs模式">​</a></h3>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<p>说明：ube-proxy开启ipvs的前提需要加载以下的内核模块</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_wrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ip_vs_sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nf_conntrack_ipv4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>果出现<code>modprobe: FATAL: Module nf_conntrack_ipv4 not found in directory /lib/modules/5.15.0-69-generic</code>错误，这是因为使用了高内核，当前内核版本为5.15.0-69-generic，在高版本内核已经把nf_conntrack_ipv4替换为nf_conntrack了。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1、安装ipvs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> ipvsadm ipset sysstat conntrack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2、加载内核模块脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /etc/profile.d/ipvs.modules </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">modprobe -- ip_vs</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">modprobe -- ip_vs_rr</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">modprobe -- ip_vs_wrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">modprobe -- ip_vs_sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">modprobe -- nf_conntrack</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">755</span><span class="token plain"> /etc/profile.d/ipvs.modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#3、执行加载模块脚本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> /etc/profile.d/ipvs.modules </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> lsmod </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> ip_vs </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> nf_conntrack_ipv4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>conntrack 是 Linux 内核的一个连接跟踪工具，用于跟踪和管理网络连接。它可以查看当前活动的连接状态、连接计数等信息，还可以手动添加、删除或修改连接跟踪条目。</p>
<a name="BSsJj"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四安装etcd集群">四、安装etcd集群<a class="hash-link" aria-label="Direct link to 四、安装etcd集群" title="Direct link to 四、安装etcd集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#四安装etcd集群">​</a></h2>
<a name="Lpapr"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41手动生成etcd集群相关证书">4.1、手动生成etcd集群相关证书<a class="hash-link" aria-label="Direct link to 4.1、手动生成etcd集群相关证书" title="Direct link to 4.1、手动生成etcd集群相关证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#41手动生成etcd集群相关证书">​</a></h3>
<p><strong>说明</strong>：kubernetes系统各组件需要使用TLS(SSL)证书对通信进行加密，本文档使用CloudFlare的PKI工具集cfssl来生成Certificate Authority (CA) 证书和秘钥文件，CA是自签名的证书，用来签名后续创建的其它TLS证书。<br><strong>说明</strong>：其中<code>ca.pem</code>、<code>ca-key.pem</code>、<code>apiserver-etcd-client.pem</code>、<code>apiserver-etcd-client-key.pem</code>文件是kube-apiserver连接etcd所需证书。这三个证书需要上传到master节点上，需提前创建好证书存放目录，建议目录如下：</p>
<table><thead><tr><th><strong>证书文件</strong></th><th><strong>秘钥文件</strong></th><th><strong>建议路径</strong></th><th><strong>节点</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>ca.pem</td><td>ca-key.pem</td><td>/etc/kubernetes/pki/etcd</td><td>master节点</td><td>etcd集群ca根证书</td></tr><tr><td>apiserver-etcd-client.pem</td><td>apiserver-etcd-client-key.pem</td><td>/etc/kubernetes/pki</td><td>master节点</td><td>apiserver连接etcd客户端证书</td></tr></tbody></table>
<a name="T6nuA"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42安装cfssl工具集">4.2、安装cfssl工具集<a class="hash-link" aria-label="Direct link to 4.2、安装cfssl工具集" title="Direct link to 4.2、安装cfssl工具集" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#42安装cfssl工具集">​</a></h3>
<p><strong>cfssl</strong> 是 Cloudflare 开发的一个工具集，用于配置和管理 TLS/SSL 证书。它提供了一组 命令行工具，用于生成、签名和管理 SSL 证书、密钥和证书签名请求 (CSR)。cfssl 还支持从 JSON 配置文件中定义证书颁发机构 (CA) 和证书配置，并可以轻松地集成到自动化工作流程中。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl_1.6.3_linux_amd64 </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /usr/local/bin/cfssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssljson_1.6.3_linux_amd64  </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /usr/local/bin/cfssljson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl-certinfo_1.6.3_linux_amd64  </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /usr/local/bin/cfssl-certinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> https://dl.k8s.io/release/v1.24.12/bin/linux/amd64/kubectl </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /usr/local/bin/kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> cfssl_1.6.3_linux_amd64 /usr/local/bin/cfssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> cfssljson_1.6.3_linux_amd64 /usr/local/bin/cfssljson</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> cfssl-certinfo_1.6.3_linux_amd64  /usr/local/bin/cfssl-certinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /usr/local/bin/cfssl*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /usr/local/bin/cfssl* </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="OS0zf"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43创建ca证书配置文件">4.3、创建CA证书配置文件<a class="hash-link" aria-label="Direct link to 4.3、创建CA证书配置文件" title="Direct link to 4.3、创建CA证书配置文件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#43创建ca证书配置文件">​</a></h3>
<p><strong>说明：根据K8S集群要求，需要三个CA证书，分别是etcd CA证书、front-proxy CA证书、kubernetes CA证书。这些CA 证书可以共用一个相同的CA证书配置文件。</strong></p>
<a name="ITU1m"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="431创建ca证书配置文件目录">4.3.1、创建CA证书配置文件目录<a class="hash-link" aria-label="Direct link to 4.3.1、创建CA证书配置文件目录" title="Direct link to 4.3.1、创建CA证书配置文件目录" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#431创建ca证书配置文件目录">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> /opt/ssl </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /opt/ssl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> ca-config.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;864000h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;profiles&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;server&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;864000h&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;usages&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;key encipherment&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;server auth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;client&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;864000h&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;usages&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;key encipherment&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;client auth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;peer&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;864000h&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;usages&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;signing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;key encipherment&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;server auth&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;client auth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>字段参数详解：</strong></p>
<ul>
<li><strong>ca-config.json</strong>：可以定义多个profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个profile；</li>
<li><strong>signing</strong>：表示该证书可用于签名其它证书；生成的ca.pem证书中CA=TRUE；</li>
<li><strong>peer</strong>：双向证书，用于etcd集群成员间通信</li>
<li><strong>server auth</strong>：表示client可以用该CA对server提供的证书进行验证；</li>
<li><strong>client auth</strong>：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
<a name="BRMeU"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44生成etcd相关证书">4.4、生成etcd相关证书<a class="hash-link" aria-label="Direct link to 4.4、生成etcd相关证书" title="Direct link to 4.4、生成etcd相关证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#44生成etcd相关证书">​</a></h3>
<a name="ZoFwt"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="441创建证书文件目录">4.4.1、创建证书文件目录<a class="hash-link" aria-label="Direct link to 4.4.1、创建证书文件目录" title="Direct link to 4.4.1、创建证书文件目录" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#441创建证书文件目录">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> /opt/ssl/etcd </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> /opt/ssl/etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="El3bu"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="442生成-etcd-ca-证书">4.4.2、生成 etcd CA 证书<a class="hash-link" aria-label="Direct link to 4.4.2、生成 etcd CA 证书" title="Direct link to 4.4.2、生成 etcd CA 证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#442生成-etcd-ca-证书">​</a></h4>
<p><strong>1、创建</strong><code>**etcd-ca-csr.json**</code><strong>文件，这是etcd CA证书的签名请求文件</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> etcd-ca-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd-ca&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Etcd Security&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;ca&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;expiry&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;876000h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>字段参数详解：</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C: Country， 国家</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ST: State，州，省</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">L: Locality，地区，城市</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">O: Organization Name，组织名称，公司名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OU: Organization Unit Name，组织单位名称，公司部门</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2、生成CA证书并复制到etcd各个节点的/etc/kubernetes/pki/etcd目录</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cfssl gencert </span><span class="token parameter variable" style="color:#36acaa">-initca</span><span class="token plain"> etcd-ca-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> ca</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ca.pem ca-key.pem /etc/kubernetes/pki/etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="AMk4V"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="443生成etcd-server证书">4.4.3、生成etcd server证书<a class="hash-link" aria-label="Direct link to 4.4.3、生成etcd server证书" title="Direct link to 4.4.3、生成etcd server证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#443生成etcd-server证书">​</a></h4>
<p><strong>1、创建etcd-server-csr.json文件，这是etcd server证书的签名请求文件</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> etcd-server-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Etcd Security&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2、生成server证书并复制到etcd各个节点 和 master节点的</strong><code>**/etc/kubernetes/pki/etcd**</code><strong>目录</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">etcd_hostname_list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1,etcd01,etcd02,etcd03,192.168.10.96,192.168.10.97,192.168.10.98&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfssl gencert </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${etcd_hostname_list}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> etcd-server-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:/opt/ssl/etcd</span><span class="token comment" style="color:#999988;font-style:italic"># cfssl gencert \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${etcd_hostname_list}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">server </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> etcd-server-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:27 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:27 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:27 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:27 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:39:27 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">419232648468514885186105614358060927394626523270</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:/opt/ssl/etcd</span><span class="token comment" style="color:#999988;font-style:italic"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca.csr  ca-key.pem  ca.pem  etcd-ca-csr.json  etcd-server-csr.json  server.csr  server-key.pem  server.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> server.pem server-key.pem /etc/kubernetes/pki/etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="mSeHz"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="444生成etcd-client证书">4.4.4、生成etcd client证书<a class="hash-link" aria-label="Direct link to 4.4.4、生成etcd client证书" title="Direct link to 4.4.4、生成etcd client证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#444生成etcd-client证书">​</a></h4>
<p><strong>1、创建</strong><code>**etcd-client-csr.json**</code><strong>文件，这是etcd client证书的签名请求文件</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> etcd-client-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-etcd-healthcheck-client&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Etcd Security&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2、生成client证书并复制到etcd各个节点的</strong><code>**/etc/kubernetes/pki/etcd**</code><strong>目录</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cfssl gencert </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">client </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> etcd-client-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> healthcheck-client</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:/opt/ssl/etcd</span><span class="token comment" style="color:#999988;font-style:italic"># cfssl gencert \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">client </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> etcd-client-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> healthcheck-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generate received request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> received CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> generating key: rsa-2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> encoded CSR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> signed certificate with serial number </span><span class="token number" style="color:#36acaa">695857563543274434659736593339791061583803283439</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">/03/07 </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:40:50 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This certificate lacks a </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token plain"> field. This makes it unsuitable </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">websites. For </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information see the Baseline Requirements </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the Issuance and Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">https://cabforum.org</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">specifically, section </span><span class="token number" style="color:#36acaa">10.2</span><span class="token plain">.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Information Requirements&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:/opt/ssl/etcd</span><span class="token comment" style="color:#999988;font-style:italic"># ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca.csr      ca.pem            etcd-client-csr.json  healthcheck-client.csr      healthcheck-client.pem  server-key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ca-key.pem  etcd-ca-csr.json  etcd-server-csr.json  healthcheck-client-key.pem  server.csr              server.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> healthcheck-client.pem healthcheck-client-key.pem /etc/kubernetes/pki/etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="i5Ylv"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="445生成etcd-peer证书">4.4.5、生成etcd peer证书<a class="hash-link" aria-label="Direct link to 4.4.5、生成etcd peer证书" title="Direct link to 4.4.5、生成etcd peer证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#445生成etcd-peer证书">​</a></h4>
<p><strong>1、创建</strong><code>**etcd-peer-csr.json**</code><strong>文件，这是etcd peer证书的签名请求文件</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> etcd-peer-csr.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-etcd-peer&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;etcd&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Etcd Security&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2、生成peer证书并复制到etcd各个节点的</strong><code>**/etc/kubernetes/pki/etcd**</code><strong>目录</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">etcd_hostname_list</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1,etcd01,etcd02,etcd03,192.168.10.96,192.168.10.97,192.168.10.98&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cfssl gencert </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${etcd_hostname_list}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">peer </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> etcd-peer-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> peer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> peer.pem peer-key.pem /etc/kubernetes/pki/etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/kubernetes/pki/etcd/ </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#1、etcd各个节点所需证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> ca-key.pem ca.pem healthcheck-client.pem healthcheck-client-key.pem peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer-key.pem server.pem server-key.pem root@192.168.10.97:/etc/kubernetes/pki/etcd/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> ca-key.pem ca.pem healthcheck-client.pem healthcheck-client-key.pem peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">peer-key.pem server.pem server-key.pem root@192.168.10.98:/etc/kubernetes/pki/etcd/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#2、master节点所需证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /opt/ssl/etcd/ca.pem /opt/ssl/etcd/ca-key.pem /etc/kubernetes/pki/etcd/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /opt/ssl/etcd/apiserver-etcd-client.pem /opt/ssl/etcd/apiserver-etcd-client-key.pem /etc/kubernetes/pki/etcd/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /opt/ssl/etcd/peer-key.pem /opt/ssl/etcd/peer.pem /etc/kubernetes/pki/etcd/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#master节点所需证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> server.pem server-key.pem healthcheck-client.pem healthcheck-client-key.pem peer.pem peer-key.pem apiserver-etcd-client.pem apiserver-etcd-client-key.pem /etc/kubernetes/pki/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<br>
<a name="bGmdt"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="446生成apiserver访问etcd-client证书"><strong>4.4.6、生成apiserver访问etcd client证书</strong><a class="hash-link" aria-label="Direct link to 446生成apiserver访问etcd-client证书" title="Direct link to 446生成apiserver访问etcd-client证书" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#446生成apiserver访问etcd-client证书">​</a></h4>
<p><strong>说明：</strong><code>**apiserver-etcd-client.pem**</code><strong>、</strong><code>**apiserver-etcd-client-key.pem**</code><strong>用于API服务器安全地连接到etcd的客户端证书。</strong></p>
<p><strong>1、创建</strong><code>**apiserver-etcd-client-csr.json**</code><strong>文件，这是etcd客户端证书的签名请求文件</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> apiserver-etcd-client-csr.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-apiserver-etcd-client&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;hosts&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;algo&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rsa&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;names&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CN&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;ST&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;L&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Beijing&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;O&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;system:masters&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;OU&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Kubernetes-manual&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2、生成apiserver-etcd-client证书并复制到master节点的</strong><code>**/etc/kubernetes/pki**</code><strong>目录</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cfssl gencert </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-ca</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/ssl/etcd/ca.pem -ca-key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/opt/ssl/etcd/ca-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/ca-config.json </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-profile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">client </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">-loglevel</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> apiserver-etcd-client-csr.json </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> cfssljson </span><span class="token parameter variable" style="color:#36acaa">-bare</span><span class="token plain"> apiserver-etcd-client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> apiserver-etcd-client.pem apiserver-etcd-client-key.pem /etc/kubernetes/pki</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="OjToa"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="45二进制安装etcd集群"><strong>4.5、二进制安装etcd集群</strong><a class="hash-link" aria-label="Direct link to 45二进制安装etcd集群" title="Direct link to 45二进制安装etcd集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#45二进制安装etcd集群">​</a></h3>
<p><strong>4.5.1、下载etcd二进制安装包</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> axf /tmp/etcd-v3.5.6-linux-amd64.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> ./etcd-v3.5.6-linux-amd64/etcd* /usr/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># scp etcd-v3.5.6-linux-amd64.tar.gz 192.168.10.97:/tmp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># scp etcd-v3.5.6-linux-amd64.tar.gz 192.168.10.98:/tmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="PYj9N"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="452创建service文件"><strong>4.5.2、创建Service文件</strong><a class="hash-link" aria-label="Direct link to 452创建service文件" title="Direct link to 452创建service文件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#452创建service文件">​</a></h4>
<p><strong>etcd01节点</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@etcd01:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat /etc/systemd/system/etcd.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Etcd Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Wants</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/coreos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">notify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WorkingDirectory</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token parameter variable" style="color:#36acaa">--name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd01 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-advertise-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.96:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.96:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.96:2379,http://127.0.0.1:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --advertise-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.96:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd-cluster </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd01=https://192.168.10.96:2380,etcd02=https://192.168.10.97:2380,etcd03=https://192.168.10.98:2380&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-state</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">new </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --data-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wal-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --snapshot-count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">50000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-retention</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">periodic </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --max-request-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10485760</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --quota-backend-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8589934592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RestartSec</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OOMScoreAdjust</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>etcd02节点</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@etcd02:~</span><span class="token comment" style="color:#999988;font-style:italic">#  cat /etc/systemd/system/etcd.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Etcd Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Wants</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/coreos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">notify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WorkingDirectory</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token parameter variable" style="color:#36acaa">--name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd02 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-advertise-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.97:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.97:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.97:2379,http://127.0.0.1:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --advertise-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.97:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd-cluster </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd01=https://192.168.10.96:2380,etcd02=https://192.168.10.97:2380,etcd03=https://192.168.10.98:2380&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-state</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">new </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --data-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wal-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --snapshot-count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">50000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-retention</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">periodic </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --max-request-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10485760</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --quota-backend-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8589934592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RestartSec</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OOMScoreAdjust</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>eth03</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@etcd03:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat /etc/systemd/system/etcd.service </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Unit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Description</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Etcd Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">After</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Wants</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">network-online.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Documentation</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://github.com/coreos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">notify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WorkingDirectory</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token parameter variable" style="color:#36acaa">--name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd03 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/peer-key.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --peer-trusted-ca-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/ca.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-advertise-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.98:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-peer-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.98:2380 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --listen-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.98:2379,http://127.0.0.1:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --advertise-client-urls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://192.168.10.98:2379 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd-cluster </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;etcd01=https://192.168.10.96:2380,etcd02=https://192.168.10.97:2380,etcd03=https://192.168.10.98:2380&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --initial-cluster-state</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">new </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --data-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/var/lib/etcd </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --wal-dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --snapshot-count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">50000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-retention</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --auto-compaction-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">periodic </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --max-request-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10485760</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --quota-backend-bytes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8589934592</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RestartSec</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LimitNOFILE</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">65536</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">OOMScoreAdjust</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-999</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Install</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">WantedBy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">multi-user.target</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="LcAla"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="453启动etcd服务">4.5.3、启动etcd服务<a class="hash-link" aria-label="Direct link to 4.5.3、启动etcd服务" title="Direct link to 4.5.3、启动etcd服务" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#453启动etcd服务">​</a></h4>
<p>注意：必须创建先etcd数据目录和工作目录。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /var/lib/etcd </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">700</span><span class="token plain"> /var/lib/etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> etcd </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> systemctl restart etcd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="Wv5zC"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="454检查etcd集群状态">4.5.4、检查etcd集群状态<a class="hash-link" aria-label="Direct link to 4.5.4、检查etcd集群状态" title="Direct link to 4.5.4、检查etcd集群状态" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#454检查etcd集群状态">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># systemctl status etcd.service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">● etcd.service - Etcd Server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Loaded: loaded </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/etc/systemd/system/etcd.service</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> vendor preset: enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Active: active </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> since Thu </span><span class="token number" style="color:#36acaa">2024</span><span class="token plain">-03-07 </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:22:26 CST</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 1min 12s ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Docs: https://github.com/coreos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Main PID: </span><span class="token number" style="color:#36acaa">864881</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Tasks: </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limit: </span><span class="token number" style="color:#36acaa">9447</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Memory: </span><span class="token number" style="color:#36acaa">26</span><span class="token plain">.3M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     CGroup: /system.slice/etcd.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             └─864881 /usr/bin/etcd </span><span class="token parameter variable" style="color:#36acaa">--name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">etcd01 --cert-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server.pem --key-file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/pki/etcd/server-key.pem </span><span class="token parameter variable" style="color:#36acaa">--peer</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl </span><span class="token parameter variable" style="color:#36acaa">--endpoints</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.10.96:2379,https://192.168.10.97:2379,https://192.168.10.98:2379&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">--cacert</span><span class="token plain"> /etc/kubernetes/pki/etcd/ca.pem </span><span class="token parameter variable" style="color:#36acaa">--cert</span><span class="token plain"> /etc/kubernetes/pki/etcd/peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">--key</span><span class="token plain">  /etc/kubernetes/pki/etcd/peer-key.pem endpoint health</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">etcdctl </span><span class="token parameter variable" style="color:#36acaa">--endpoints</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://192.168.10.96:2379,https://192.168.10.97:2379,https://192.168.10.98:2379&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">--cacert</span><span class="token plain"> /etc/kubernetes/pki/etcd/ca.pem </span><span class="token parameter variable" style="color:#36acaa">--cert</span><span class="token plain"> /etc/kubernetes/pki/etcd/peer.pem </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token parameter variable" style="color:#36acaa">--key</span><span class="token plain">  /etc/kubernetes/pki/etcd/peer-key.pem endpoint status --write-out table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>如下图所示：</strong><br><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/33538388/1709803520352-67ff4038-ef28-4eaa-8322-4d2094e8233b.png#averageHue=%232b2825&amp;clientId=u44e99244-39de-4&amp;from=paste&amp;height=119&amp;id=u78033956&amp;originHeight=119&amp;originWidth=1250&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=29217&amp;status=done&amp;style=none&amp;taskId=u91f5b2af-ba6b-449a-b261-16e31227aaa&amp;title=&amp;width=1250" alt="image.png" class="img_ev3q"><br><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/33538388/1709803586296-e3ef59ec-836f-4419-b2c7-e065deae0b8f.png#averageHue=%23252321&amp;clientId=u44e99244-39de-4&amp;from=paste&amp;height=188&amp;id=u7a52a1c2&amp;originHeight=188&amp;originWidth=1603&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=38925&amp;status=done&amp;style=none&amp;taskId=uce4adb36-db7d-43f4-bb05-bd7180111fc&amp;title=&amp;width=1603" alt="image.png" class="img_ev3q"></p>
<a name="tdo0G"></a>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="456etcd集群备份">4.5.6、<a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/" target="_blank" rel="noopener noreferrer">etcd集群备份</a><a class="hash-link" aria-label="Direct link to 456etcd集群备份" title="Direct link to 456etcd集群备份" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#456etcd集群备份">​</a></h4>
<p><strong>备份etcd集群可以通过两种方式完成：etcd内置快照和卷快照。</strong><br><strong>参考：</strong><a href="https://blog.csdn.net/m0_37814112/article/details/130502953" target="_blank" rel="noopener noreferrer">《Kubernetes备份篇：etcd集群数据备份与恢复》</a></p>
<a name="Ef3L3"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五安装containerd">五、安装containerd<a class="hash-link" aria-label="Direct link to 五、安装containerd" title="Direct link to 五、安装containerd" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#五安装containerd">​</a></h2>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<p>kubernetes 1.24.x以后版本默认CRI为containerd，cri称之为容器运行时插件。</p>
<p>方式一、二进制安装<br>方式二、apt工具安装</p>
<a name="eAMgD"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51安装软件包">5.1、安装软件包<a class="hash-link" aria-label="Direct link to 5.1、安装软件包" title="Direct link to 5.1、安装软件包" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#51安装软件包">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt-cache</span><span class="token plain"> madison containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerd </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.7</span><span class="token plain">.2-0ubuntu1~20.04.1 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal-updates/main amd64 Packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerd </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain">.12-0ubuntu1~20.04.3 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">containerd </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.3</span><span class="token plain">.3-0ubuntu2 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> http://mirrors.tuna.tsinghua.edu.cn/ubuntu focal/main amd64 Packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">containerd</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain">.12-0ubuntu1~20.04.3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="t2qxd"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52生成默认配置文件">5.2、生成默认配置文件<a class="hash-link" aria-label="Direct link to 5.2、生成默认配置文件" title="Direct link to 5.2、生成默认配置文件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#52生成默认配置文件">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> /etc/containerd</span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="MjMld"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53配置systemd-cgroup驱动">5.3、配置systemd cgroup驱动<a class="hash-link" aria-label="Direct link to 5.3、配置systemd cgroup驱动" title="Direct link to 5.3、配置systemd cgroup驱动" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#53配置systemd-cgroup驱动">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s#SystemdCgroup = false#SystemdCgroup = true#g&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="c8Yhu"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54重载沙箱pause镜像">5.4、重载沙箱（pause）镜像<a class="hash-link" aria-label="Direct link to 5.4、重载沙箱（pause）镜像" title="Direct link to 5.4、重载沙箱（pause）镜像" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#54重载沙箱pause镜像">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s#sandbox_image = &quot;registry.k8s.io/pause:3.6&quot;#sandbox_image = &quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7&quot;#g&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="nGKMF"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="55重启containerd服务并设置开机自启">5.5、重启containerd服务并设置开机自启<a class="hash-link" aria-label="Direct link to 5.5、重启containerd服务并设置开机自启" title="Direct link to 5.5、重启containerd服务并设置开机自启" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#55重启containerd服务并设置开机自启">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> containerd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明：由于网络问题，无法下载国外的K8S镜像，所以这里使用阿里云的镜像仓库地址<code>registry.cn-hangzhou.aliyuncs.com/google_containers</code>代替。如果你有阿里云的账号，可以对 containerd配置镜像加速地址来实现快速下载镜像。</p>
<a name="zeKpC"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="56下载pause镜像">5.6、下载pause镜像<a class="hash-link" aria-label="Direct link to 5.6、下载pause镜像" title="Direct link to 5.6、下载pause镜像" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#56下载pause镜像">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="UIAiO"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="57配置containerd配置镜像加速">5.7、配置containerd配置镜像加速<a class="hash-link" aria-label="Direct link to 5.7、配置containerd配置镜像加速" title="Direct link to 5.7、配置containerd配置镜像加速" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#57配置containerd配置镜像加速">​</a></h3>
<p><strong>直接在</strong><code>** /etc/containerd/config.toml **</code><strong>文件中添加配置，配置好后重启containerd服务：</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugins.</span><span class="token string" style="color:#e3116c">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token plain">.registry.mirrors</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugins.</span><span class="token string" style="color:#e3116c">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token plain">.registry.mirrors.</span><span class="token string" style="color:#e3116c">&quot;docker.io&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;https://zltjecyf.mirror.aliyuncs.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugins.</span><span class="token string" style="color:#e3116c">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token plain">.registry.mirrors.</span><span class="token string" style="color:#e3116c">&quot;k8s.gcr.io&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;https://registry.aliyuncs.com/k8sxio&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="j8Fjl"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="58安装crictl命令行工具">5.8、安装crictl命令行工具<a class="hash-link" aria-label="Direct link to 5.8、安装crictl命令行工具" title="Direct link to 5.8、安装crictl命令行工具" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#58安装crictl命令行工具">​</a></h3>
<p>crictl与kubernetes版本对应：<br><a href="https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.26.1" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/cri-tools/releases/tag/v1.26.1</a><br><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/33538388/1709864817722-8ebdfdc3-a3f4-4845-94e3-965ca8fd4e78.png#averageHue=%23141a21&amp;clientId=u44e99244-39de-4&amp;from=paste&amp;height=520&amp;id=kND5U&amp;originHeight=520&amp;originWidth=547&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=33646&amp;status=done&amp;style=none&amp;taskId=u60aa74da-6a2c-4622-a69f-a084fc2c0ab&amp;title=&amp;width=547" alt="image.png" class="img_ev3q"></p>
<blockquote>
<p><strong>crictl-v1.26.1-linux-amd64.tar.gz</strong>
链接：<a href="https://pan.baidu.com/s/1D3wqxUWo6Zz7PHZ_00l9zA?pwd=k8ss" target="_blank" rel="noopener noreferrer">https://pan.baidu.com/s/1D3wqxUWo6Zz7PHZ_00l9zA?pwd=k8ss</a>
提取码：k8ss</p>
</blockquote>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> axf crictl-v1.26.1-linux-amd64.tar.gz </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>说明：ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互。</strong></p>
<a name="WatNC"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="59安装nerdctl命令行工具">5.9、安装nerdctl命令行工具<a class="hash-link" aria-label="Direct link to 5.9、安装nerdctl命令行工具" title="Direct link to 5.9、安装nerdctl命令行工具" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#59安装nerdctl命令行工具">​</a></h3>
<p><strong>下载安装</strong></p>
<blockquote>
<p><strong>nerdctl-1.7.4-linux-amd64.tar.gz</strong>
<strong>链接：</strong><a href="https://pan.baidu.com/s/1hdIp5ltCmr59FISKVlUyhQ?pwd=k8ss" target="_blank" rel="noopener noreferrer"><strong>https://pan.baidu.com/s/1hdIp5ltCmr59FISKVlUyhQ?pwd=k8ss</strong></a>** **
**提取码：k8ss **</p>
</blockquote>
<p>官方下载地址： <a href="https://github.com/containerd/nerdctl/releases" target="_blank" rel="noopener noreferrer">https://github.com/containerd/nerdctl/releases</a>，在 Asset 中选择下载精简或者完全安装包。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-xzvf</span><span class="token plain"> nerdctl-*-linux-amd64.tar.gz </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /usr/local/bin/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="wYRVj"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="六安装kubeletkubeadm和kubectl">六、<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener noreferrer">安装kubelet、kubeadm和kubectl</a><a class="hash-link" aria-label="Direct link to 六安装kubeletkubeadm和kubectl" title="Direct link to 六安装kubeletkubeadm和kubectl" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#六安装kubeletkubeadm和kubectl">​</a></h2>
<p><strong>说明：以下操作无论是master节点和worker节点均需要执行。</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#1、安装使用Kubernetes apt仓库所需要的包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">containerd</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.6</span><span class="token plain">.12-0ubuntu1~20.04.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#2、编辑镜像源文件，加入阿里云k8s镜像源配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/apt/sources.list.d/kubernetes.list</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#3、编辑镜像源文件，加入阿里云k8s镜像源配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> apt-key </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#更新源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#5、安装指定版本kubeadm、kubelet、kubectl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">kubelet</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.24</span><span class="token plain">.12-00 </span><span class="token assign-left variable" style="color:#36acaa">kubeadm</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.24</span><span class="token plain">.12-00 </span><span class="token assign-left variable" style="color:#36acaa">kubectl</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.24</span><span class="token plain">.12-00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#设置kubelet开机自启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#kubectl命令补全</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;source &lt;(kubectl completion bash)&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/profile.d/k8s.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">source</span><span class="token plain"> /etc/profile.d/k8s.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="Ufd5p"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="七k8s镜像下载">七、k8s镜像下载<a class="hash-link" aria-label="Direct link to 七、k8s镜像下载" title="Direct link to 七、k8s镜像下载" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#七k8s镜像下载">​</a></h2>
<p>说明：以下操作无论是master节点和worker节点均需要执行。</p>
<p>需要下载的镜像</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/kube-apiserver:v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/kube-controller-manager:v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/kube-scheduler:v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/kube-proxy:v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/pause:3.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/etcd:3.5.6-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">registry.k8s.io/coredns/coredns:v1.8.6</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>使用国内源下载相关镜像</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">k8s_version</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">pause_version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3.7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">etcd_version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain">.6-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">coredns_version</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">v1.8.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">registry_address</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">registry.cn-hangzhou.aliyuncs.com/google_containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-apiserver:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-controller-manager:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-scheduler:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-proxy:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/pause:</span><span class="token variable" style="color:#36acaa">${pause_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/etcd:</span><span class="token variable" style="color:#36acaa">${etcd_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image pull --all-platforms </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/coredns:</span><span class="token variable" style="color:#36acaa">${coredns_version}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>将镜像并打包成tar.gz格式</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">k8s_version</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">pause_version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3.7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">etcd_version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3.5</span><span class="token plain">.6-0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">coredns_version</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">v1.8.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">registry_address</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">registry.cn-hangzhou.aliyuncs.com/google_containers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms kube-apiserver-</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-apiserver:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms kube-controller-manager-</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-controller-manager:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms kube-scheduler-</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain">.tar.gz </span><span class="token punctuation" style="color:#393A34">\</span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-scheduler:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms kube-proxy-</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/kube-proxy:</span><span class="token variable" style="color:#36acaa">${k8s_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms pause-</span><span class="token variable" style="color:#36acaa">${pause_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/pause:</span><span class="token variable" style="color:#36acaa">${pause_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms etcd-</span><span class="token variable" style="color:#36acaa">${etcd_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/etcd:</span><span class="token variable" style="color:#36acaa">${etcd_version}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr image </span><span class="token builtin class-name">export</span><span class="token plain"> --all-platforms coredns-</span><span class="token variable" style="color:#36acaa">${coredns_version}</span><span class="token plain">.tar.gz </span><span class="token variable" style="color:#36acaa">${registry_address}</span><span class="token plain">/coredns:</span><span class="token variable" style="color:#36acaa">${coredns_version}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>说明：由于网络问题，无法访问<strong>registry.k8s.io</strong>镜像仓库地址，这里使用国内阿里云的镜像仓库来下载k8s镜像。如果你的是专网环境，请找一台能访问阿里云镜像仓库的服务器下载然后打包成tar.gz格式，上传到要部署的专网服务器，通过ctr image import命令导入镜像即可。</p>
</blockquote>
<a name="aYUyp"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="八使用kubeadm-init初始化集群">八、使用kubeadm init初始化集群<a class="hash-link" aria-label="Direct link to 八、使用kubeadm init初始化集群" title="Direct link to 八、使用kubeadm init初始化集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#八使用kubeadm-init初始化集群">​</a></h2>
<p><strong>说明：以下操作仅在master节点执行。</strong></p>
<a name="BeFa9"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81生成默认kubeadm初始化config文件">8.1、生成默认kubeadm初始化config文件<a class="hash-link" aria-label="Direct link to 8.1、生成默认kubeadm初始化config文件" title="Direct link to 8.1、生成默认kubeadm初始化config文件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#81生成默认kubeadm初始化config文件">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubeadm config print init-defaults </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubeadm.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="MD7PS"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82修改kubeadm默认config文件">8.2、修改kubeadm默认config文件<a class="hash-link" aria-label="Direct link to 8.2、修改kubeadm默认config文件" title="Direct link to 8.2、修改kubeadm 默认config文件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#82修改kubeadm默认config文件">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kubeadm.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubeadm.k8s.io/v1beta3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">bootstrapTokens</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">groups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> system</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">bootstrappers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">kubeadm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">default</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> abcdef.0123456789abcdef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ttl</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24h0m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">usages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">localAPIEndpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">advertiseAddress</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.10.96&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">bindPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">nodeRegistration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">criSocket</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unix</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">///var/run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> master01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">taints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">#给master添加污点，master节点不能调度应用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">effect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;NoSchedule&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;node-role.kubernetes.io/master&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubeadm.k8s.io/v1beta3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">etcd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">external</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//192.168.10.96</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//192.168.10.97</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//192.168.10.98</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">caFile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kubernetes/pki/etcd/ca.pem </span><span class="token comment" style="color:#999988;font-style:italic"># 连接etcd所需证书</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">certFile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kubernetes/pki/apiserver</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">etcd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">client.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">keyFile</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kubernetes/pki/apiserver</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">etcd</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">key.pem  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dnsDomain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceSubnet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.96.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">podSubnet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10.244.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kubernetesVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;v1.24.12&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">controlPlaneEndpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;192.168.10.96:6443&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiServer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">extraArgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service-node-port-range</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 30000</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">36000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">timeoutForControlPlane</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 4m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">certificatesDir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kubernetes/pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">clusterName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">controllerManager</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">imageRepository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ipvs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="xkl2w"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="83-使用kubeadm-init初始化集群">8.3、 使用kubeadm init初始化集群<a class="hash-link" aria-label="Direct link to 8.3、 使用kubeadm init初始化集群" title="Direct link to 8.3、 使用kubeadm init初始化集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#83-使用kubeadm-init初始化集群">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~/k8sdata/init</span><span class="token comment" style="color:#999988;font-style:italic"># kubeadm init --config=kubeadm.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using Kubernetes version: v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Running pre-flight checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Pulling images required </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> setting up a Kubernetes cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> This might take a minute or two, depending on the speed of your internet connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> You can also perform this action </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> beforehand using </span><span class="token string" style="color:#e3116c">&#x27;kubeadm config images pull&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using certificateDir folder </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/pki&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;ca&quot;</span><span class="token plain"> certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;apiserver&quot;</span><span class="token plain"> certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> apiserver serving cert is signed </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> DNS names </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master01</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and IPs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.0.1 </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.96</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;apiserver-kubelet-client&quot;</span><span class="token plain"> certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;front-proxy-ca&quot;</span><span class="token plain"> certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;front-proxy-client&quot;</span><span class="token plain"> certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> External etcd mode: Skipping etcd/ca certificate authority generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> External etcd mode: Skipping etcd/server certificate generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> External etcd mode: Skipping etcd/peer certificate generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> External etcd mode: Skipping etcd/healthcheck-client certificate generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> External etcd mode: Skipping apiserver-etcd-client certificate generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Generating </span><span class="token string" style="color:#e3116c">&quot;sa&quot;</span><span class="token plain"> key and public key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubeconfig</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using kubeconfig folder </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubeconfig</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing </span><span class="token string" style="color:#e3116c">&quot;admin.conf&quot;</span><span class="token plain"> kubeconfig </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubeconfig</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing </span><span class="token string" style="color:#e3116c">&quot;kubelet.conf&quot;</span><span class="token plain"> kubeconfig </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubeconfig</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing </span><span class="token string" style="color:#e3116c">&quot;controller-manager.conf&quot;</span><span class="token plain"> kubeconfig </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubeconfig</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing </span><span class="token string" style="color:#e3116c">&quot;scheduler.conf&quot;</span><span class="token plain"> kubeconfig </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet environment </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with flags to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet configuration to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting the kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using manifest folder </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/manifests&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating static Pod manifest </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-apiserver&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating static Pod manifest </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-controller-manager&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating static Pod manifest </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kube-scheduler&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">wait-control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the kubelet to boot up the control plane as static Pods from directory </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/manifests&quot;</span><span class="token builtin class-name">.</span><span class="token plain"> This can take up to 4m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">apiclient</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> All control plane components are healthy after </span><span class="token number" style="color:#36acaa">10.503878</span><span class="token plain"> seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">upload-config</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Storing the configuration used </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> ConfigMap </span><span class="token string" style="color:#e3116c">&quot;kubeadm-config&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the </span><span class="token string" style="color:#e3116c">&quot;kube-system&quot;</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating a ConfigMap </span><span class="token string" style="color:#e3116c">&quot;kubelet-config&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> namespace kube-system with the configuration </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the kubelets </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">upload-certs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Skipping phase. Please see --upload-certs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">mark-control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Marking the </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> master01 as control-plane by adding the labels: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">mark-control-plane</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Marking the </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> master01 as control-plane by adding the taints </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">node-role.kubernetes.io/master:NoSchedule</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Using token: abcdef.0123456789abcdef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> order </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> nodes to get long term certificate credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Configured RBAC rules to allow certificate rotation </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> all </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> client certificates </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bootstrap-token</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating the </span><span class="token string" style="color:#e3116c">&quot;cluster-info&quot;</span><span class="token plain"> ConfigMap </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the </span><span class="token string" style="color:#e3116c">&quot;kube-public&quot;</span><span class="token plain"> namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-finalize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Updating </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/kubelet.conf&quot;</span><span class="token plain"> to point to a rotatable kubelet client certificate and key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">addons</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Applied essential addon: CoreDNS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">addons</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Applied essential addon: kube-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Your Kubernetes control-plane has initialized successfully</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To start using your cluster, you need to run the following as a regular user:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> /etc/kubernetes/admin.conf </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable parameter variable" style="color:#36acaa">-u</span><span class="token variable" style="color:#36acaa">)</span><span class="token builtin class-name">:</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">id</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable parameter variable" style="color:#36acaa">-g</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alternatively, </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> you are the root user, you can run:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">KUBECONFIG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/admin.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You should now deploy a pod network to the cluster.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run </span><span class="token string" style="color:#e3116c">&quot;kubectl apply -f [podnetwork].yaml&quot;</span><span class="token plain"> with one of the options listed at:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You can now </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> any number of control-plane nodes by copying certificate authorities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">and </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> account keys on each </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> and </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> running the following as root:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.96:6443 </span><span class="token parameter variable" style="color:#36acaa">--token</span><span class="token plain"> abcdef.0123456789abcdef </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --discovery-token-ca-cert-hash sha256:fc9ca7c0388b444f80b339e6595fd32feee9da46ea1c9a61528481a69fc3e006 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --control-plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Then you can </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> any number of worker nodes by running the following on each as root:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.10.96:6443 </span><span class="token parameter variable" style="color:#36acaa">--token</span><span class="token plain"> abcdef.0123456789abcdef </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --discovery-token-ca-cert-hash sha256:fc9ca7c0388b444f80b339e6595fd32feee9da46ea1c9a61528481a69fc3e006</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="ZTGBh"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="84node01节点加入k8s集群">8.4、node01节点加入K8S集群<a class="hash-link" aria-label="Direct link to 8.4、node01节点加入K8S集群" title="Direct link to 8.4、node01节点加入K8S集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#84node01节点加入k8s集群">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubeadm join 192.168.10.96:6443 --token abcdef.0123456789abcdef \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">         --discovery-token-ca-cert-hash sha256:fc9ca7c0388b444f80b339e6595fd32feee9da46ea1c9a61528481a69fc3e006</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Running pre-flight checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Reading configuration from the cluster</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FYI: You can </span><span class="token function" style="color:#d73a49">look</span><span class="token plain"> at this config </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with </span><span class="token string" style="color:#e3116c">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet configuration to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet environment </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with flags to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting the kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the kubelet to perform the TLS Bootstrap</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> has joined the cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Certificate signing request was sent to apiserver and a response was received.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* The Kubelet was informed of the new secure connection details.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run </span><span class="token string" style="color:#e3116c">&#x27;kubectl get nodes&#x27;</span><span class="token plain"> on the control-plane to see this </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> the cluster.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="podXg"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="85node02节点加入k8s集群">8.5、node02节点加入K8S集群<a class="hash-link" aria-label="Direct link to 8.5、node02节点加入K8S集群" title="Direct link to 8.5、node02节点加入K8S集群" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#85node02节点加入k8s集群">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node02:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubeadm join 192.168.10.96:6443 --token abcdef.0123456789abcdef \</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">         --discovery-token-ca-cert-hash sha256:fc9ca7c0388b444f80b339e6595fd32feee9da46ea1c9a61528481a69fc3e006</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Running pre-flight checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Reading configuration from the cluster</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">preflight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FYI: You can </span><span class="token function" style="color:#d73a49">look</span><span class="token plain"> at this config </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with </span><span class="token string" style="color:#e3116c">&#x27;kubectl -n kube-system get cm kubeadm-config -o yaml&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet configuration to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Writing kubelet environment </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> with flags to </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting the kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubelet-start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the kubelet to perform the TLS Bootstrap</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> has joined the cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Certificate signing request was sent to apiserver and a response was received.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* The Kubelet was informed of the new secure connection details.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Run </span><span class="token string" style="color:#e3116c">&#x27;kubectl get nodes&#x27;</span><span class="token plain"> on the control-plane to see this </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> the cluster.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>查看集群状态</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS     ROLES           AGE     VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master01   NotReady   control-plane   4m36s   v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node01     NotReady   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          67s     v1.24.12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node02     NotReady   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          41s     v1.24.12</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因为没有安装<strong>网络插件处于NotReady状态</strong></p>
<a name="axx6p"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="九安装网络组件">九、安装网络组件<a class="hash-link" aria-label="Direct link to 九、安装网络组件" title="Direct link to 九、安装网络组件" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#九安装网络组件">​</a></h2>
<p>这个时候其实集群还不能正常使用，因为还没有安装网络插件，接下来安装网络插件，可以在文档 <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a> 中选择我们自己的网络插件，这里我们安装 flannel:<br><a href="https://github.com/flannel-io/flannel" target="_blank" rel="noopener noreferrer">https://github.com/flannel-io/flannel</a></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">pod-security.kubernetes.io/enforce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> privileged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> pods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> get</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> watch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> nodes/status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> patch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">apiGroups</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> networking.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> clustercidrs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">verbs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> watch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">cni-conf.json</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;name&quot;: &quot;cbr0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;plugins&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;type&quot;: &quot;flannel&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;delegate&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            &quot;hairpinMode&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            &quot;isDefaultGateway&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;type&quot;: &quot;portmap&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          &quot;capabilities&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">            &quot;portMappings&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">net-conf.json</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      &quot;Backend&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">        &quot;Type&quot;: &quot;vxlan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> node</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">affinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">nodeAffinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">nodeSelectorTerms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matchExpressions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> In</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ip</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">masq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">subnet</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">iface=eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /opt/bin/flanneld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> POD_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EVENT_QUEUE_DEPTH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/flannel/flannel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.24.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 50Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">add</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> NET_ADMIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> NET_RAW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">privileged</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /run/flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /run/xtables.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xtables</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostNetwork</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">initContainers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /opt/cni/bin/flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/flannel/flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cni</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v1.4.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> install</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cni</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /opt/cni/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cni</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /etc/kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel/cni</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /etc/cni/net.d/10</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel.conflist</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> cp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> docker.io/flannel/flannel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v0.24.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> install</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/cni/net.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">priorityClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> system</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">critical</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tolerations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">effect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">operator</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /run/flannel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /opt/cni/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cni</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/cni/net.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cni</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> flannel</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cfg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /run/xtables.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> FileOrCreate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xtables</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> kube-flannel.yml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl appl </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain">  kube-flannel.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="wKA9d"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="十安装kubernetes-dashboard">十、安装Kubernetes-Dashboard<a class="hash-link" aria-label="Direct link to 十、安装Kubernetes-Dashboard" title="Direct link to 十、安装Kubernetes-Dashboard" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#十安装kubernetes-dashboard">​</a></h2>
<p>1.24版本的K8S对应dashboard 2.6.1版本<br>具体：<a href="https://github.com/kubernetes/dashboard/releases/tag/v2.6.1" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/dashboard/releases/tag/v2.6.1</a><br><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/33538388/1709889395231-0decfd0d-4b5f-4094-ac50-80522266910b.png#averageHue=%2310151c&amp;clientId=u44e99244-39de-4&amp;from=paste&amp;height=605&amp;id=u76adf9fa&amp;originHeight=666&amp;originWidth=1212&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=50644&amp;status=done&amp;style=none&amp;taskId=u49b1d07d-e5ff-4a65-8b91-892e20066db&amp;title=&amp;width=1101.8181579369164" alt="image.png" class="img_ev3q"></p>
<a name="gApNV"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="101增加nodeport方式暴露服务">10.1、增加NodePort方式暴露服务<a class="hash-link" aria-label="Direct link to 10.1、增加NodePort方式暴露服务" title="Direct link to 10.1、增加NodePort方式暴露服务" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#101增加nodeport方式暴露服务">​</a></h3>
<p>官方部署仪表板的服务没使用nodeport，将yaml文件下载到本地，在service里添加nodeport</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain">  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-rc7/aio/deploy/recommended.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果此方式无法下载可通过浏览器访问自行创建</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 编辑文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vim recommended.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NodePort		</span><span class="token comment" style="color:#999988;font-style:italic">#新增</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30000</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">#新增</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">k8s-app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 部署Dashboard    </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f recommended.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建完成后，检查相关服务运行状态</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get deployment kubernetes-dashboard </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kubernetes-dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kubernetes-dashboard </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> wide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get services </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kubernetes-dashboard</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -ntlp</span><span class="token operator" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30001</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在浏览器中访问Dashboard</p>
<a name="XQTwP"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="102创建dashboard-admin-token">10.2、创建Dashboard-admin token<a class="hash-link" aria-label="Direct link to 10.2、创建Dashboard-admin token" title="Direct link to 10.2、创建Dashboard-admin token" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#102创建dashboard-admin-token">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create serviceaccount  dashboard-admin </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create clusterrolebinding  dashboard-admin </span><span class="token parameter variable" style="color:#36acaa">--clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster-admin </span><span class="token parameter variable" style="color:#36acaa">--serviceaccount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system:dashboard-admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe secrets </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kube-system </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl </span><span class="token variable parameter variable" style="color:#36acaa">-n</span><span class="token variable" style="color:#36acaa"> kube-system get secret </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;/dashboard-admin/{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>1.24版本创建不过期token</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create serviceaccount  dashboard-admin </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create clusterrolebinding  dashboard-admin </span><span class="token parameter variable" style="color:#36acaa">--clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cluster-admin </span><span class="token parameter variable" style="color:#36acaa">--serviceaccount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system:dashboard-admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dashboard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dashboard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">subjects</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dashboard</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">roleRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">apiGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 上面均为正常的建立ServiceAccount并与集群默认角色cluster-admin进行绑定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 下面为手动建立secret文件进行永久token建立</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/service-account.name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dashboard-admin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">token</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl describe </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> kube-system secret/secret-admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/src/k8s/KubernetesTraining3/实验环境部署/Kubeadm+外部etcd部署集群.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/k8s/KubernetesTraining3/实验环境部署/3333"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">发布集群控制面板</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubeadm 部署集群</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#一架构图">一、架构图</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#二环境信息">二、环境信息</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#三安装和配置先决条件">三、安装和配置先决条件</a><ul><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#31主机名设置">3.1、主机名设置</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#32配置主机hosts">3.2、配置主机hosts</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#33关闭防火墙">3.3、关闭防火墙</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#34关闭selinux">3.4、关闭selinux</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#35关闭swap分区">3.5、关闭swap分区</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#36时间时区同步">3.6、时间时区同步</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#37修改内核参数">3.7、修改内核参数</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#38启用ipvs模式">3.8、启用IPVS模式</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#四安装etcd集群">四、安装etcd集群</a><ul><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#41手动生成etcd集群相关证书">4.1、手动生成etcd集群相关证书</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#42安装cfssl工具集">4.2、安装cfssl工具集</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#43创建ca证书配置文件">4.3、创建CA证书配置文件</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#44生成etcd相关证书">4.4、生成etcd相关证书</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#45二进制安装etcd集群"><strong>4.5、二进制安装etcd集群</strong></a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#五安装containerd">五、安装containerd</a><ul><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#51安装软件包">5.1、安装软件包</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#52生成默认配置文件">5.2、生成默认配置文件</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#53配置systemd-cgroup驱动">5.3、配置systemd cgroup驱动</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#54重载沙箱pause镜像">5.4、重载沙箱（pause）镜像</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#55重启containerd服务并设置开机自启">5.5、重启containerd服务并设置开机自启</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#56下载pause镜像">5.6、下载pause镜像</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#57配置containerd配置镜像加速">5.7、配置containerd配置镜像加速</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#58安装crictl命令行工具">5.8、安装crictl命令行工具</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#59安装nerdctl命令行工具">5.9、安装nerdctl命令行工具</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#六安装kubeletkubeadm和kubectl">六、安装kubelet、kubeadm和kubectl</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#七k8s镜像下载">七、k8s镜像下载</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#八使用kubeadm-init初始化集群">八、使用kubeadm init初始化集群</a><ul><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#81生成默认kubeadm初始化config文件">8.1、生成默认kubeadm初始化config文件</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#82修改kubeadm默认config文件">8.2、修改kubeadm默认config文件</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#83-使用kubeadm-init初始化集群">8.3、 使用kubeadm init初始化集群</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#84node01节点加入k8s集群">8.4、node01节点加入K8S集群</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#85node02节点加入k8s集群">8.5、node02节点加入K8S集群</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#九安装网络组件">九、安装网络组件</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#十安装kubernetes-dashboard">十、安装Kubernetes-Dashboard</a><ul><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#101增加nodeport方式暴露服务">10.1、增加NodePort方式暴露服务</a></li><li><a class="table-of-contents__link toc-highlight" href="/k8s/KubernetesTraining3/LabEnvironment/kubeadm-cluster-deployment-etcd#102创建dashboard-admin-token">10.2、创建Dashboard-admin token</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>