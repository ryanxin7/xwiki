---
author: Ryan
title: 2.Traefik-ACMEè‡ªç­¾å‘è¯ä¹¦
date: 2024-03-13
tags: [Traefik]
sidebar_position: 2
---

## ACME
Traefik é€šè¿‡æ‰©å±• CRD çš„æ–¹å¼æ¥æ‰©å±• Ingress çš„åŠŸèƒ½ï¼Œé™¤äº†é»˜è®¤çš„ç”¨ Secret çš„æ–¹å¼å¯ä»¥æ”¯æŒåº”ç”¨çš„ HTTPS ä¹‹å¤–ï¼Œè¿˜æ”¯æŒè‡ªåŠ¨ç”Ÿæˆ HTTPS è¯ä¹¦ã€‚

### éƒ¨ç½² whoami æœåŠ¡
æ¯”å¦‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„** whoami** åº”ç”¨ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: whoami
spec:
  ports:
    - protocol: TCP
      name: web
      port: 80
  selector:
    app: whoami
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: whoami
  labels:
    app: whoami
spec:
  replicas: 2
  selector:
    matchLabels:
      app: whoami
  template:
    metadata:
      labels:
        app: whoami
    spec:
      containers:
        - name: whoami
          image: registry.cn-beijing.aliyuncs.com/xxk8s/whoami
          ports:
            - name: web
              containerPort: 80
```

åº”ç”¨é…ç½®
```bash
root@master01:/k8s-traefik# kubectl apply -f whoim.yaml -n test-pod
service/whoami created
deployment.apps/whoami created
root@master01:/k8s-traefik#
root@master01:/k8s-traefik# kubectl get pod -n test-pod
NAME                      READY   STATUS    RESTARTS   AGE
mysql-0                   1/1     Running   0          42h
whoami-84b5557bd8-5mlph   1/1     Running   0          4s
whoami-84b5557bd8-8rsdl   1/1     Running   0          4s
```

å®šä¹‰ä¸€ä¸ª IngressRoute å¯¹è±¡ï¼š
```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: ingressroute-demo
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`who.xinn.com`) && PathPrefix(`/notls`)
      kind: Rule
      services:
        - name: whoami
          port: 80
```

```bash
root@master01:/k8s-traefik# kubectl apply -f whoami-traefik.yaml -n test-pod
ingressroute.traefik.containo.us/ingressroute-demo created
```

é€šè¿‡ **entryPoints** æŒ‡å®šäº†æˆ‘ä»¬è¿™ä¸ªåº”ç”¨çš„å…¥å£ç‚¹æ˜¯ webï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ 32080 ç«¯å£è®¿é—®ï¼Œç„¶åè®¿é—®çš„è§„åˆ™å°±æ˜¯è¦åŒ¹é… **who.xinn.com** è¿™ä¸ªåŸŸåï¼Œå¹¶ä¸”å…·æœ‰ `/notls` çš„è·¯å¾„å‰ç¼€çš„è¯·æ±‚æ‰ä¼šè¢« whoami è¿™ä¸ª Service æ‰€åŒ¹é…ã€‚<br />æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºä¸Šé¢çš„å‡ ä¸ªèµ„æºå¯¹è±¡ï¼Œç„¶åå¯¹åŸŸååšå¯¹åº”çš„è§£æåï¼Œå°±å¯ä»¥è®¿é—®åº”ç”¨äº†ï¼š<br />

![2b215164fd04](http://img.xinn.cc/2b215164fd04.png)



åœ¨ IngressRoute å¯¹è±¡ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸€äº›åŒ¹é…è§„åˆ™ï¼Œè¿™äº›è§„åˆ™åœ¨ Traefik ä¸­æœ‰å¦‚ä¸‹å®šä¹‰æ–¹å¼ï¼š<br />
![4e593ec95bc8](http://img.xinn.cc/4e593ec95bc8.png)

### ä½¿ç”¨è‡ªç­¾åè¯ä¹¦

å¦‚æœæˆ‘ä»¬éœ€è¦ç”¨ HTTPS æ¥è®¿é—®æˆ‘ä»¬è¿™ä¸ªåº”ç”¨çš„è¯ï¼Œå°±éœ€è¦ç›‘å¬ websecure è¿™ä¸ªå…¥å£ç‚¹ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ 443 ç«¯å£æ¥è®¿é—®ï¼ŒåŒæ ·ç”¨ HTTPS è®¿é—®åº”ç”¨å¿…ç„¶å°±éœ€è¦è¯ä¹¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ openssl æ¥åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„è¯ä¹¦ï¼š
```shell
$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=who.xinn.com"
```
ç„¶åé€šè¿‡ Secret å¯¹è±¡æ¥å¼•ç”¨è¯ä¹¦æ–‡ä»¶ï¼š
```shell
# è¦æ³¨æ„è¯ä¹¦æ–‡ä»¶åç§°å¿…é¡»æ˜¯ tls.crt å’Œ tls.key
root@master01:/k8s-traefik# kubectl create secret tls who-tls --cert=tls.crt --key=tls.key -n test-pod
secret/who-tls created
```
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª HTTPS è®¿é—®åº”ç”¨çš„ IngressRoute å¯¹è±¡äº†ï¼š


```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: ingressroute-tls-demo
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`who.xinn.com`) && PathPrefix(`/tls`)
      kind: Rule
      services:
        - name: whoami
          port: 80
  tls:
    secretName: who-tls
```

```bash
root@master01:/k8s-traefik# vim whoami-traefik-tls.yaml
root@master01:/k8s-traefik# kubectl apply -f whoami-traefik-tls.yaml -n test-pod
ingressroute.traefik.containo.us/ingressroute-tls-demo created
```

åˆ›å»ºå®Œæˆåå°±å¯ä»¥é€šè¿‡ HTTPS æ¥è®¿é—®åº”ç”¨äº†ï¼Œç”±äºæˆ‘ä»¬æ˜¯è‡ªç­¾åçš„è¯ä¹¦ï¼Œæ‰€ä»¥è¯ä¹¦æ˜¯ä¸å—ä¿¡ä»»çš„ï¼š<br />

![9d297cda970f](http://img.xinn.cc/9d297cda970f.png)


### åŸºäº ACME è‡ªç­¾å‘è¯ä¹¦
é™¤äº†æ‰‹åŠ¨æä¾›è¯ä¹¦çš„æ–¹å¼ä¹‹å¤– Traefik åŒæ ·ä¹Ÿæ”¯æŒä½¿ç”¨ **Letâ€™s Encrypt**è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ï¼Œè¦ä½¿ç”¨ Letâ€™s Encrypt æ¥è¿›è¡Œè‡ªåŠ¨åŒ– HTTPSï¼Œå°±éœ€è¦é¦–å…ˆå¼€å¯ ACMEï¼Œå¼€å¯ ACME éœ€è¦é€šè¿‡é™æ€é…ç½®çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ã€å¯åŠ¨å‚æ•°ç­‰æ–¹å¼æ¥æä¾›ã€‚<br />ACME æœ‰å¤šç§æ ¡éªŒæ–¹å¼ **tlsChallenge**ã€**httpChallenge** å’Œ **dnsChallenge** ä¸‰ç§éªŒè¯æ–¹å¼ï¼Œä¹‹å‰æ›´å¸¸ç”¨çš„æ˜¯ http è¿™ç§éªŒè¯æ–¹å¼ï¼Œå…³äºè¿™å‡ ç§éªŒè¯æ–¹å¼çš„ä½¿ç”¨å¯ä»¥æŸ¥çœ‹æ–‡æ¡£ï¼š[https://www.qikqiak.com/traefik-book/https/acme/](https://www.qikqiak.com/traefik-book/https/acme/) äº†è§£ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚è¦ä½¿ç”¨ tls æ ¡éªŒæ–¹å¼çš„è¯éœ€è¦ä¿è¯ Traefik çš„ 443 ç«¯å£æ˜¯å¯è¾¾çš„ï¼Œdns æ ¡éªŒæ–¹å¼å¯ä»¥ç”Ÿæˆé€šé…ç¬¦çš„è¯ä¹¦ï¼Œåªéœ€è¦é…ç½®ä¸Š DNS è§£ææœåŠ¡å•†çš„ API è®¿é—®å¯†é’¥å³å¯æ ¡éªŒã€‚æˆ‘ä»¬è¿™é‡Œç”¨ DNS æ ¡éªŒçš„æ–¹å¼æ¥ä¸ºå¤§å®¶è¯´æ˜å¦‚ä½•é…ç½® ACMEã€‚<br />æˆ‘ä»¬å¯ä»¥é‡æ–°ä¿®æ”¹ Helm å®‰è£…çš„ values é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹æ‰€ç¤ºçš„å®šåˆ¶å‚æ•°ï¼š
```yaml
# ci/deployment-prod.yaml
# è®¾ç½® Traefik çš„ ACME è‡ªåŠ¨è¯ä¹¦ç®¡ç†åŠŸèƒ½
additionalArguments:
  # ä½¿ç”¨ dns éªŒè¯æ–¹å¼
  - --certificatesResolvers.ali.acme.dnsChallenge.provider=alidns
  # ä½¿ç”¨é˜¿é‡Œäº‘ DNS éªŒè¯åŸŸåæ‰€æœ‰æƒ
  # å…ˆä½¿ç”¨stagingç¯å¢ƒè¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯æˆåŠŸåå†ä½¿ç”¨ç§»é™¤ä¸‹é¢ä¸€è¡Œçš„é…ç½®
  # - --certificatesResolvers.ali.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory
  # é‚®ç®±é…ç½®
  - --certificatesResolvers.ali.acme.email=562188771@qq.com
  # ä¿å­˜ ACME è¯ä¹¦çš„ä½ç½®
  - --certificatesResolvers.ali.acme.storage=/data/acme.json

envFrom:
  - secretRef:
      name: traefik-alidns-secret
      # ALICLOUD_ACCESS_KEY
      # ALICLOUD_SECRET_KEY
      # ALICLOUD_REGION_ID

#persistence:
#  enabled: true # å¼€å¯æŒä¹…åŒ–
# accessMode: ReadWriteOnce
#  size: 128Mi
#  path: /data
  
persistence:
  enabled: true
  name: data
#  existingClaim: ""
  accessMode: ReadWriteOnce
  size: 128Mi
  storageClass: "rook-cephfs"
  # volumeName: ""
  path: /data
  annotations: {}



# ç”±äºä¸Šé¢æŒä¹…åŒ–äº†ACMEçš„æ•°æ®ï¼Œéœ€è¦é‡æ–°é…ç½®ä¸‹é¢çš„å®‰å…¨ä¸Šä¸‹æ–‡
securityContext:
  readOnlyRootFilesystem: false
  runAsGroup: 0
  runAsUser: 0
  runAsNonRoot: false
```

```bash
kubectl create secret generic traefik-alidns-secret -n kube-system \
  --from-literal=KEY=xxxxxxxxxxxxxx \
  --from-literal=SECRET_KEY=xxxxxxxxxxxxxx \
  --from-literal=REGION_ID=cn-beijing
```

è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® `--certificatesresolvers.ali.acme.dnschallenge.provider=alidns` å‚æ•°æ¥æŒ‡å®šæŒ‡å®šé˜¿é‡Œäº‘çš„ DNS æ ¡éªŒï¼Œè¦ä½¿ç”¨é˜¿é‡Œäº‘çš„ DNS æ ¡éªŒæˆ‘ä»¬è¿˜éœ€è¦é…ç½® 3 ä¸ªç¯å¢ƒå˜é‡ï¼š`ALICLOUD_ACCESS_KEY`ã€`ALICLOUD_SECRET_KEY`ã€`ALICLOUD_REGION_ID`ï¼Œåˆ†åˆ«å¯¹åº”æˆ‘ä»¬å¹³æ—¶å¼€å‘é˜¿é‡Œäº‘åº”ç”¨çš„æ—¶å€™çš„å¯†é’¥ï¼Œå¯ä»¥ç™»å½•é˜¿é‡Œäº‘åå° [https://ram.console.aliyun.com/manage/ak](https://ram.console.aliyun.com/manage/ak) è·å–ï¼Œç”±äºè¿™æ˜¯æ¯”è¾ƒç§å¯†çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ Secret å¯¹è±¡æ¥åˆ›å»ºï¼š
```shell
$ kubectl create secret generic traefik-alidns-secret --from-literal=ALICLOUD_ACCESS_KEY=<aliyun ak> --from-literal=ALICLOUD_SECRET_KEY=<aliyun sk> --from-literal=ALICLOUD_REGION_ID=cn-beijing -n kube-system
```


åˆ›å»ºå®Œæˆåå°†è¿™ä¸ª Secret é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®åˆ° Traefik çš„åº”ç”¨ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯éªŒè¯é€šè¿‡çš„è¯ä¹¦æˆ‘ä»¬è¿™é‡Œå­˜åˆ° `/data/acme.json` æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸€å®šè¦å°†è¿™ä¸ªæ–‡ä»¶æŒä¹…åŒ–ï¼Œå¦åˆ™æ¯æ¬¡ Traefik é‡å»ºåå°±éœ€è¦é‡æ–°è®¤è¯ï¼Œè€Œ Letâ€™s Encrypt æœ¬èº«æ ¡éªŒæ¬¡æ•°æ˜¯æœ‰é™åˆ¶çš„ã€‚<br />æ‰€ä»¥æˆ‘ä»¬åœ¨ values ä¸­é‡æ–°å¼€å¯äº†æ•°æ®æŒä¹…åŒ–ï¼Œä¸è¿‡å¼€å¯è¿‡åéœ€è¦æˆ‘ä»¬æä¾›ä¸€ä¸ªå¯ç”¨çš„ PV å­˜å‚¨ï¼Œç”±äºæˆ‘ä»¬å°† Traefik å›ºå®šåˆ° master1 èŠ‚ç‚¹ä¸Šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª hostpath ç±»å‹çš„ PVï¼ˆåé¢ä¼šè¯¦ç»†è®²è§£ï¼‰ï¼š
```shell
$ cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  name: traefik
spec:
  accessModes:
  - ReadWriteOnce
  capacity:
    storage: 128Mi
  hostPath:
    path: /data/k8s/traefik
EOF
```

```bash
root@master01:/k8s-traefik# kubectl get pvc -n kube-system
NAME      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
traefik   Bound    pvc-856bc7d6-4d51-4904-b200-57c63cc1d38e   128Mi      RWO            rook-cephfs    3m10s
```


```bash
root@master01:/k8s-traefik/traefik# helm upgrade --install traefik ./ -f ./xin-traefik-valuse.yaml --namespace kube-system
Release "traefik" has been upgraded. Happy Helming!
NAME: traefik
LAST DEPLOYED: Wed Aug 28 16:52:29 2024
NAMESPACE: kube-system
STATUS: deployed
REVISION: 4
TEST SUITE: None
NOTES:
Traefik Proxy v2.10.4 has been deployed successfully on kube-system namespace !

ğŸš¨ When enabling persistence for certificates, permissions on acme.json can be
lost when Traefik restarts. You can ensure correct permissions with an
initContainer. See https://github.com/traefik/traefik-helm-chart/issues/396 for
more info. ğŸš¨

```

ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤æ›´æ–° Traefikï¼š
```shell
$ helm upgrade --install traefik ./traefik -f ./traefik/ci/deployment-prod.yaml --namespace kube-system
```

æ›´æ–°å®Œæˆåç°åœ¨æˆ‘ä»¬æ¥ä¿®æ”¹ä¸Šé¢æˆ‘ä»¬çš„ whoami åº”ç”¨ï¼š
```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: ingressroute-tls-demo
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`who.qikqiak.com`) && PathPrefix(`/tls`)
      kind: Rule
      services:
        - name: whoami
          port: 80
  tls:
    certResolver: ali
    domains:
      - main: '*.qikqiak.com'
```

åœ¨ Traefik çš„é…ç½®ä¸­ï¼Œä½¿ç”¨ `certResolver` æŒ‡å®šäº†ä¸€ä¸ª ACME è¯ä¹¦è§£æå™¨ã€‚è¿™ä¸ªè§£æå™¨è´Ÿè´£ä¸ ACME æœåŠ¡å™¨ï¼ˆå¦‚ Let's Encryptï¼‰è¿›è¡Œäº¤äº’ï¼Œä»¥è‡ªåŠ¨è·å–å’Œç»­è®¢è¯ä¹¦ã€‚<br />`certResolver: ali`æŒ‡å®šä½¿ç”¨åä¸º `ali` çš„è¯ä¹¦è§£æå™¨ã€‚<br />é€šè¿‡æŒ‡å®š `.xinn.cc`ï¼Œè·å–ä¸€ä¸ªé€šé…ç¬¦è¯ä¹¦ï¼Œè¿™ä¸ªè¯ä¹¦å°†é€‚ç”¨äº `xinn.cc` ä¸‹çš„æ‰€æœ‰å­åŸŸåã€‚<br />åœ¨ Traefik çš„ ACME é…ç½®ä¸­ï¼ŒæŒ‡å®šäº†è¯ä¹¦å­˜å‚¨çš„è·¯å¾„ã€‚é€šå¸¸ï¼ŒTraefik ä¼šå°†å¤šä¸ªåŸŸåçš„è¯ä¹¦è‡ªåŠ¨å†™å…¥åˆ°åŒä¸€ä¸ª `acme.json` æ–‡ä»¶ä¸­ï¼Œå®ƒå­˜å‚¨äº†ç”± ACME è¯ä¹¦è§£æå™¨ï¼ˆ`certResolver`ï¼‰ç®¡ç†çš„ SSL/TLS è¯ä¹¦ä»¥åŠç›¸å…³çš„å¯†é’¥å’Œå…ƒæ•°æ®ã€‚

- **é¦–æ¬¡è·å–**: å½“ä¸€ä¸ªæ–°çš„åŸŸåè¯·æ±‚åˆ°è¾¾ Traefikï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨ TLS åŠ å¯†æ—¶ï¼ŒTraefik ä¼šæ£€æŸ¥ `acme.json` æ–‡ä»¶ä¸­æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„è¯ä¹¦ã€‚å¦‚æœæ²¡æœ‰ï¼ŒTraefik ä¼šä½¿ç”¨ ACME åè®®ä¸æŒ‡å®šçš„ ACME æœåŠ¡å™¨é€šä¿¡ï¼Œè‡ªåŠ¨ç”³è¯·ä¸€ä¸ªæ–°çš„è¯ä¹¦ã€‚
- **ç»­è®¢è¯ä¹¦**: Traefik ä¼šè‡ªåŠ¨æ£€æŸ¥å·²ç»å­˜å‚¨çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼Œå¹¶åœ¨è¯ä¹¦æ¥è¿‘è¿‡æœŸæ—¶è‡ªåŠ¨ä¸ ACME æœåŠ¡å™¨é€šä¿¡æ¥ç»­è®¢è¯ä¹¦ã€‚ç»­è®¢åçš„è¯ä¹¦ä¹Ÿä¼šå­˜å‚¨åœ¨ `acme.json` æ–‡ä»¶ä¸­ã€‚

```bash
root@master01:/k8s-traefik# kubectl apply -f whoami-traefik-tls-ali.yaml -n test-pod
ingressroute.traefik.containo.us/ingressroute-tls-demo created
```

å…¶ä»–çš„éƒ½ä¸å˜ï¼Œåªéœ€è¦å°† tls éƒ¨åˆ†æ”¹æˆæˆ‘ä»¬å®šä¹‰çš„ ali è¿™ä¸ªè¯ä¹¦è§£æå™¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ç”Ÿæˆä¸€ä¸ªé€šé…ç¬¦çš„åŸŸåè¯ä¹¦çš„è¯å¯ä»¥å®šä¹‰ domains å‚æ•°æ¥æŒ‡å®šï¼Œç„¶åæ›´æ–° IngressRoute å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å»ç”¨ HTTPS è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ï¼ˆå½“ç„¶éœ€è¦å°†åŸŸååœ¨é˜¿é‡Œäº‘ DNS ä¸Šåšè§£æï¼‰ï¼š<br />


![85a9ae64b2bd](http://img.xinn.cc/85a9ae64b2bd.png)


æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è®¿é—®åº”ç”¨å·²ç»æ˜¯å—æµè§ˆå™¨ä¿¡ä»»çš„è¯ä¹¦äº†ï¼ŒæŸ¥çœ‹è¯ä¹¦æˆ‘ä»¬è¿˜å¯ä»¥å‘ç°è¯¥è¯ä¹¦æ˜¯ä¸€ä¸ªé€šé…ç¬¦çš„è¯ä¹¦ã€‚

